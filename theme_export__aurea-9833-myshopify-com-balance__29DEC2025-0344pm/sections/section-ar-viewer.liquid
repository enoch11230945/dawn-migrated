{% comment %}
  AR/3D Model Viewer for Moissanite Products
  PRD v2.0: "3D/AR content boosts conversion by 94%"
  
  Supports:
  - 3D model rotation (.glb files)
  - AR view on mobile (iOS/Android)
  - Lazy loading for performance
  
  Usage: Add as block in product template for high-value SKUs
{% endcomment %}

{%- style -%}
  .ar-viewer-container {
    margin: 2rem 0;
    position: relative;
  }

  .ar-viewer-wrapper {
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    border-radius: var(--media-radius);
    overflow: hidden;
    position: relative;
    aspect-ratio: 1 / 1;
  }

  .model-viewer-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .model-viewer-placeholder:hover {
    background: linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 100%);
  }

  .mv-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.7;
  }

  .mv-text {
    font-size: 1.6rem;
    font-weight: 600;
    color: rgb(var(--color-foreground));
    margin-bottom: 0.5rem;
  }

  .mv-subtext {
    font-size: 1.3rem;
    color: rgba(var(--color-foreground), 0.6);
  }

  model-viewer {
    width: 100%;
    height: 100%;
    --poster-color: transparent;
  }

  .ar-controls {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 1rem;
    z-index: 2;
  }

  .ar-button {
    background: white;
    border: 2px solid rgba(var(--color-foreground), 0.2);
    padding: 1rem 2rem;
    border-radius: 3rem;
    font-size: 1.4rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .ar-button:hover {
    background: rgb(var(--color-button));
    color: rgb(var(--color-button-text));
    border-color: rgb(var(--color-button));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  }

  .ar-button svg {
    width: 1.8rem;
    height: 1.8rem;
  }

  .ar-feature-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
    justify-content: center;
  }

  .ar-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.8rem 1.5rem;
    background: rgba(var(--color-button), 0.1);
    border-radius: 2rem;
    font-size: 1.2rem;
    font-weight: 600;
    color: rgb(var(--color-button));
  }

  .ar-badge svg {
    width: 1.6rem;
    height: 1.6rem;
  }

  @media (max-width: 750px) {
    .ar-controls {
      flex-direction: column;
      width: 90%;
    }

    .ar-button {
      justify-content: center;
      width: 100%;
    }
  }
{%- endstyle -%}

<div class="ar-viewer-container" id="ar-viewer-{{ section.id }}">
  <div class="ar-viewer-wrapper">
    {% if section.settings.model_3d != blank %}
      <!-- Placeholder - Lazy load model-viewer on click -->
      <div class="model-viewer-placeholder" id="mv-placeholder-{{ section.id }}">
        <div class="mv-icon">ðŸ”„</div>
        <div class="mv-text">View in 3D</div>
        <div class="mv-subtext">Click to load interactive model</div>
      </div>
    {% else %}
      <!-- Fallback if no 3D model uploaded -->
      <div class="model-viewer-placeholder">
        <div class="mv-icon">ðŸ“¦</div>
        <div class="mv-text">3D Model Coming Soon</div>
        <div class="mv-subtext">Upload a .glb file in section settings</div>
      </div>
    {% endif %}
  </div>

  {% if section.settings.show_feature_badges %}
  <div class="ar-feature-badges">
    <div class="ar-badge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
        <path d="M2 17l10 5 10-5"></path>
        <path d="M2 12l10 5 10-5"></path>
      </svg>
      360Â° Rotation
    </div>
    <div class="ar-badge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
        <path d="M16 3h2a2 2 0 0 1 2 2v2"></path>
      </svg>
      AR View
    </div>
    <div class="ar-badge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="M21 21l-4.35-4.35"></path>
      </svg>
      Zoom In/Out
    </div>
  </div>
  {% endif %}
</div>

<script type="module">
  // Lazy load model-viewer library only when needed
  function loadModelViewer() {
    if (!customElements.get('model-viewer')) {
      const script = document.createElement('script');
      script.type = 'module';
      script.src = 'https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js';
      document.head.appendChild(script);
    }
  }

  // Initialize viewer
  (function() {
    const container = document.getElementById('ar-viewer-{{ section.id }}');
    const placeholder = document.getElementById('mv-placeholder-{{ section.id }}');
    
    if (!placeholder) return;

    placeholder.addEventListener('click', function() {
      // Load model-viewer library
      loadModelViewer();

      // Create model-viewer element
      const viewer = document.createElement('model-viewer');
      viewer.setAttribute('src', '{{ section.settings.model_3d | file_url }}');
      viewer.setAttribute('alt', '{{ section.settings.alt_text | escape }}');
      viewer.setAttribute('auto-rotate', '');
      viewer.setAttribute('camera-controls', '');
      viewer.setAttribute('shadow-intensity', '1');
      
      {% if section.settings.enable_ar %}
      viewer.setAttribute('ar', '');
      viewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
      viewer.setAttribute('ios-src', '{{ section.settings.model_ios | default: section.settings.model_3d | file_url }}');
      {% endif %}

      // Add AR button if mobile
      if (viewer.canActivateAR) {
        const arButton = document.createElement('button');
        arButton.className = 'ar-button';
        arButton.setAttribute('slot', 'ar-button');
        arButton.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 3h2a2 2 0 0 1 2 2v2"></path>
          </svg>
          View in Your Space
        `;
        viewer.appendChild(arButton);
      }

      // Replace placeholder with viewer
      placeholder.parentElement.replaceChild(viewer, placeholder);
    }, { once: true });
  })();
</script>

{% schema %}
{
  "name": "AR/3D Model Viewer",
  "tag": "section",
  "class": "section-ar-viewer",
  "settings": [
    {
      "type": "header",
      "content": "3D Model Files"
    },
    {
      "type": "file",
      "id": "model_3d",
      "label": "3D Model (.glb)",
      "accept": ".glb"
    },
    {
      "type": "file",
      "id": "model_ios",
      "label": "iOS AR Model (.usdz) - Optional",
      "accept": ".usdz",
      "info": "If not provided, .glb will be used for iOS AR"
    },
    {
      "type": "text",
      "id": "alt_text",
      "label": "Model Description",
      "default": "3D model of product"
    },
    {
      "type": "header",
      "content": "Features"
    },
    {
      "type": "checkbox",
      "id": "enable_ar",
      "label": "Enable AR Mode",
      "default": true,
      "info": "Allows customers to view product in their space via AR"
    },
    {
      "type": "checkbox",
      "id": "show_feature_badges",
      "label": "Show Feature Badges",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "AR/3D Model Viewer"
    }
  ]
}
{% endschema %}
