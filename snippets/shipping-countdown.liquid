{%- comment -%}
  London_Emotion_Engine - Shipping Countdown Snippet
  Displays deadline for guaranteed arrival (Valentine's Day, Mother's Day, etc.)
  
  Usage: {% render 'shipping-countdown', deadline_date: '2026-02-07', occasion_name: "Valentine's Day" %}
{% comment %}
  FIXED (Linus A11y): Countdown is aria-hidden to prevent DDoS attack on screen readers
  Static fallback text provided for accessible experience
{% endcomment %}

{%- assign deadline = deadline_date | default: '' -%}
{%- assign occasion = occasion_name | default: 'the occasion' -%}

{%- if deadline_date != blank -%}
  {%- assign deadline_parts = deadline_date | split: '-' -%}
  {%- assign deadline_year = deadline_parts[0] | times: 1 -%}
  {%- assign deadline_month = deadline_parts[1] | times: 1 -%}
  {%- assign deadline_day = deadline_parts[2] | times: 1 -%}
  
  <div class="shipping-countdown-wrapper">
    {%- comment -%} Screen reader friendly static text {%- endcomment -%}
    <div class="visually-hidden" role="status" aria-live="polite">
      Order by 2PM for next day delivery. Guaranteed delivery before {{ occasion_name | default: 'your special date' }}.
    </div>
    
    {%- comment -%} Visual countdown (hidden from screen readers) {%- endcomment -%}
    <div 
      class="shipping-countdown" 
      data-deadline="{{ deadline_date }}"
      data-initialized="false"
      aria-hidden="true"
    >
      <div class="countdown-header">
        <svg class="countdown-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span class="countdown-title">Order within</span>
      </div>
      
      <div class="countdown-timer">
        <div class="countdown-unit">
          <span class="countdown-value days">0</span>
          <span class="countdown-label">days</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-unit">
          <span class="countdown-value hours">00</span>
          <span class="countdown-label">hrs</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-unit">
          <span class="countdown-value minutes">00</span>
          <span class="countdown-label">min</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-unit">
          <span class="countdown-value seconds">00</span>
          <span class="countdown-label">sec</span>
        </div>
      </div>
      
      <div class="countdown-occasion">
        To receive by <strong class="countdown-date">{{ deadline_date }}</strong>
        {% if occasion_name != blank %}
          <span class="countdown-occasion-name">({{ occasion_name }})</span>
        {% endif %}
      </div>
    </div>
  </div>

<style>
.shipping-countdown {
  background: linear-gradient(135deg, rgb(var(--color-button)), rgb(var(--color-button)) );
  color: rgb(var(--color-button-text));
  padding: 1.2rem 2rem;
  border-radius: var(--media-radius);
  margin-bottom: 2rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.shipping-countdown .countdown-inner {
  display: flex;
  align-items: center;
  gap: 1.2rem;
}

.shipping-countdown .countdown-icon {
  flex-shrink: 0;
  color: #fff;
  opacity: 0.9;
}

.shipping-countdown .countdown-text {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.shipping-countdown .countdown-label {
  font-size: 1.2rem;
}

.shipping-countdown .countdown-label strong {
  color: #fff;
  text-decoration: underline;
}

.shipping-countdown .countdown-timer {
  font-size: 1.6rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  color: #fff;
}

.shipping-countdown.expired {
  background: #a00;
}

.shipping-countdown.expired .countdown-timer {
  display: none;
}

.shipping-countdown.expired .countdown-label::after {
  content: " - ORDER NOW for fastest delivery";
  color: #fff;
  font-weight: 600;
}

@media (max-width: 750px) {
  .shipping-countdown {
    padding: 1rem 1.5rem;
  }
  
  .shipping-countdown .countdown-label {
    font-size: 1.1rem;
  }
  
  .shipping-countdown .countdown-timer {
    font-size: 1.4rem;
  }
}
</style>

<script>
(function() {
  document.querySelectorAll('.shipping-countdown').forEach(countdownEl => {
    // Skip if already initialized
    if (countdownEl.dataset.initialized) return;
    countdownEl.dataset.initialized = 'true';
    
    // Generate unique ID for this countdown
    const countdownId = `countdown-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // Use UTC timezone (+00:00) to ensure correct deadline for UK customers
    const deadline = new Date(countdownEl.dataset.deadline + 'T23:59:59+00:00').getTime();
    
    function formatDate(date) {
      const options = { day: 'numeric', month: 'short' };
      return new Date(date).toLocaleDateString('en-GB', options);
    }
    
    const dateDisplay = countdownEl.querySelector('.countdown-date');
    if (dateDisplay) {
      dateDisplay.textContent = formatDate(countdownEl.dataset.deadline);
    }
    
    function updateCountdown() {
      const now = new Date().getTime();
      const distance = deadline - now;
      
      if (distance < 0) {
        countdownEl.classList.add('expired');
        // FIXED (Linus): Use TimerManager for centralized cleanup
        if (window.TimerManager) {
          window.TimerManager.unregister(countdownId);
        }
        return;
      }
      
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      
      const daysEl = countdownEl.querySelector('.days');
      if (daysEl) daysEl.textContent = days;
      
      const hoursEl = countdownEl.querySelector('.hours');
      if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
      
      const minEl = countdownEl.querySelector('.minutes');
      if (minEl) minEl.textContent = minutes.toString().padStart(2, '0');
      
      const secEl = countdownEl.querySelector('.seconds');
      if (secEl) secEl.textContent = seconds.toString().padStart(2, '0');
    }
    
    // Initial update
    updateCountdown();
    
    // FIXED (Linus): Use global TimerManager instead of local setInterval
    if (window.TimerManager) {
      window.TimerManager.register(countdownId, updateCountdown, 1000);
    } else {
      // Fallback if TimerManager not loaded (should not happen if properly included)
      console.error('[COUNTDOWN] TimerManager not found. Include timer-manager.js in theme.liquid');
      setInterval(updateCountdown, 1000);
    }
    
    // FIXED (Linus): Lightweight cleanup observer - only watch parent, not entire document.body
    if (countdownEl.parentElement && window.MutationObserver) {
      const observer = new MutationObserver(function(mutations) {
        if (!countdownEl.isConnected) {
          if (window.TimerManager) {
            window.TimerManager.unregister(countdownId);
            window.TimerManager.unregisterObserver(countdownId);
          }
        }
      });
      observer.observe(countdownEl.parentElement, { childList: true });
      
      if (window.TimerManager) {
        window.TimerManager.registerObserver(countdownId, observer);
      }
    }
  });
})();
</script>

{%- endif -%}
